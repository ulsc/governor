name: Release Artifacts

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-artifacts:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            ext: ''
            archive: tar.gz
          - goos: linux
            goarch: arm64
            ext: ''
            archive: tar.gz
          - goos: darwin
            goarch: arm64
            ext: ''
            archive: tar.gz
          - goos: darwin
            goarch: amd64
            ext: ''
            archive: tar.gz
          - goos: windows
            goarch: amd64
            ext: .exe
            archive: zip

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Verify tag commit is on main
        run: |
          set -euo pipefail
          git fetch --no-tags origin main
          if ! git merge-base --is-ancestor "$GITHUB_SHA" "origin/main"; then
            echo "Tag commit $GITHUB_SHA is not reachable from origin/main"
            exit 1
          fi

      - name: Setup Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: '1.25.7'
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
          TAG_NAME: ${{ github.ref_name }}
          EXT: ${{ matrix.ext }}
        run: |
          set -euo pipefail
          mkdir -p dist
          go build -mod=readonly -trimpath \
            -ldflags "-s -w -X governor/internal/version.Version=${TAG_NAME}" \
            -o "dist/governor${EXT}" .

      - name: Package artifact
        env:
          TAG_NAME: ${{ github.ref_name }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          ARCHIVE_TYPE: ${{ matrix.archive }}
          EXT: ${{ matrix.ext }}
        run: |
          set -euo pipefail
          ARCHIVE_BASE="governor_${TAG_NAME}_${GOOS}_${GOARCH}"
          if [ "${ARCHIVE_TYPE}" = "zip" ]; then
            ARCHIVE_FILE="${ARCHIVE_BASE}.zip"
            (
              cd dist
              zip -q "${ARCHIVE_FILE}" "governor${EXT}"
            )
          else
            ARCHIVE_FILE="${ARCHIVE_BASE}.tar.gz"
            (
              cd dist
              tar -czf "${ARCHIVE_FILE}" "governor${EXT}"
            )
          fi
          echo "ARCHIVE_FILE=${ARCHIVE_FILE}" >> "$GITHUB_ENV"

      - name: Generate checksum
        run: |
          set -euo pipefail
          (
            cd dist
            sha256sum "${ARCHIVE_FILE}" > "${ARCHIVE_FILE}.sha256"
          )
          echo "CHECKSUM_FILE=${ARCHIVE_FILE}.sha256" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ env.ARCHIVE_FILE }}
          path: |
            dist/${{ env.ARCHIVE_FILE }}
            dist/${{ env.CHECKSUM_FILE }}
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: build-artifacts
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          path: artifacts

      - name: Collect release assets
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p release
          find artifacts -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.sha256' \) \
            -exec cp {} release/ \;

          # Generate combined checksums file
          cd release
          cat *.sha256 > "checksums_${TAG_NAME}.txt"
          ls -la

      - name: Copy install script
        run: cp install.sh release/install.sh

      - name: Generate release notes
        env:
          TAG_NAME: ${{ github.ref_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Find the previous tag (excluding the current one)
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${TAG_NAME}$" | head -n 1 || true)

          if [ -z "$PREV_TAG" ]; then
            # No previous tag â€” list all commits ungrouped
            echo "## What's Changed" > release-notes.md
            echo "" >> release-notes.md
            git log --oneline "${TAG_NAME}" >> release-notes.md
          else
            COMMITS=$(git log "${PREV_TAG}..${TAG_NAME}" --oneline)

            declare -a feat=() fix=() refactor=() docs=() test=() chore=() other=()

            while IFS= read -r line; do
              [ -z "$line" ] && continue
              hash="${line%% *}"
              short_hash="${hash:0:7}"
              rest="${line#* }"

              case "$rest" in
                feat\(*\):*)
                  scope="${rest#feat(}"
                  scope="${scope%%)*}"
                  msg="${rest#*): }"
                  feat+=("- **${scope}**: ${msg} (${short_hash})")
                  ;;
                feat:*)
                  msg="${rest#feat: }"
                  feat+=("- ${msg} (${short_hash})")
                  ;;
                fix\(*\):*)
                  scope="${rest#fix(}"
                  scope="${scope%%)*}"
                  msg="${rest#*): }"
                  fix+=("- **${scope}**: ${msg} (${short_hash})")
                  ;;
                fix:*)
                  msg="${rest#fix: }"
                  fix+=("- ${msg} (${short_hash})")
                  ;;
                refactor\(*\):*)
                  scope="${rest#refactor(}"
                  scope="${scope%%)*}"
                  msg="${rest#*): }"
                  refactor+=("- **${scope}**: ${msg} (${short_hash})")
                  ;;
                refactor:*)
                  msg="${rest#refactor: }"
                  refactor+=("- ${msg} (${short_hash})")
                  ;;
                docs\(*\):*)
                  scope="${rest#docs(}"
                  scope="${scope%%)*}"
                  msg="${rest#*): }"
                  docs+=("- **${scope}**: ${msg} (${short_hash})")
                  ;;
                docs:*)
                  msg="${rest#docs: }"
                  docs+=("- ${msg} (${short_hash})")
                  ;;
                test\(*\):*)
                  scope="${rest#test(}"
                  scope="${scope%%)*}"
                  msg="${rest#*): }"
                  test+=("- **${scope}**: ${msg} (${short_hash})")
                  ;;
                test:*)
                  msg="${rest#test: }"
                  test+=("- ${msg} (${short_hash})")
                  ;;
                chore\(*\):*)
                  scope="${rest#chore(}"
                  scope="${scope%%)*}"
                  msg="${rest#*): }"
                  chore+=("- **${scope}**: ${msg} (${short_hash})")
                  ;;
                chore:*)
                  msg="${rest#chore: }"
                  chore+=("- ${msg} (${short_hash})")
                  ;;
                *)
                  other+=("- ${rest} (${short_hash})")
                  ;;
              esac
            done <<< "$COMMITS"

            {
              echo "## What's Changed"
              echo ""

              if [ ${#feat[@]} -gt 0 ]; then
                echo "### Features"
                printf '%s\n' "${feat[@]}"
                echo ""
              fi
              if [ ${#fix[@]} -gt 0 ]; then
                echo "### Bug Fixes"
                printf '%s\n' "${fix[@]}"
                echo ""
              fi
              if [ ${#refactor[@]} -gt 0 ]; then
                echo "### Refactoring"
                printf '%s\n' "${refactor[@]}"
                echo ""
              fi
              if [ ${#docs[@]} -gt 0 ]; then
                echo "### Documentation"
                printf '%s\n' "${docs[@]}"
                echo ""
              fi
              if [ ${#test[@]} -gt 0 ]; then
                echo "### Tests"
                printf '%s\n' "${test[@]}"
                echo ""
              fi
              if [ ${#chore[@]} -gt 0 ]; then
                echo "### Chores"
                printf '%s\n' "${chore[@]}"
                echo ""
              fi
              if [ ${#other[@]} -gt 0 ]; then
                echo "### Other"
                printf '%s\n' "${other[@]}"
                echo ""
              fi

              echo "**Full Changelog**: https://github.com/${GITHUB_REPOSITORY}/compare/${PREV_TAG}...${TAG_NAME}"
            } > release-notes.md
          fi

          echo "--- Generated release notes ---"
          cat release-notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          gh release create "${TAG_NAME}" \
            --title "Governor ${TAG_NAME}" \
            --notes-file release-notes.md \
            release/*

  attest-artifacts:
    name: Attest ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ubuntu-24.04
    needs: build-artifacts
    permissions:
      contents: read
      id-token: write
      attestations: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            archive: tar.gz
          - goos: linux
            goarch: arm64
            archive: tar.gz
          - goos: darwin
            goarch: arm64
            archive: tar.gz
          - goos: darwin
            goarch: amd64
            archive: tar.gz
          - goos: windows
            goarch: amd64
            archive: zip

    steps:
      - name: Resolve archive name
        env:
          TAG_NAME: ${{ github.ref_name }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          ARCHIVE_TYPE: ${{ matrix.archive }}
        run: |
          set -euo pipefail
          ARCHIVE_BASE="governor_${TAG_NAME}_${GOOS}_${GOARCH}"
          if [ "${ARCHIVE_TYPE}" = "zip" ]; then
            ARCHIVE_FILE="${ARCHIVE_BASE}.zip"
          else
            ARCHIVE_FILE="${ARCHIVE_BASE}.tar.gz"
          fi
          echo "ARCHIVE_FILE=${ARCHIVE_FILE}" >> "$GITHUB_ENV"

      - name: Download artifact
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: ${{ env.ARCHIVE_FILE }}
          path: dist

      - name: Attest build provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2.4.0
        with:
          subject-path: dist/${{ env.ARCHIVE_FILE }}
